<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VSDTL IDE</title>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #0b0b0d;
  font-family: monospace;
  color: #eee;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* Editor stack */
#editorWrap {
  position: relative;
  flex: 1;
}

#editor {
  position: absolute;
  inset: 0;
  background: transparent;
  color: transparent;
  caret-color: #fff;
  border: none;
  outline: none;
  padding: 14px;
  font-size: 16px;
  resize: none;
  line-height: 1.4;
}

#highlight {
  position: absolute;
  inset: 0;
  pointer-events: none;
  padding: 14px;
  white-space: pre-wrap;
  line-height: 1.4;
  overflow: hidden;
}

/* Toolbar */
#toolbar {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #060608;
  border-top: 1px solid #222;
}

#runBtn {
  background: #2ecc71;
  border: none;
  border-radius: 999px;
  padding: 8px 18px;
  font-weight: bold;
  cursor: pointer;
}

/* Output */
#output {
  height: 30%;
  background: #050507;
  border-top: 1px solid #222;
  padding: 12px;
  overflow-y: auto;
  white-space: pre-wrap;
}

/* Prompt */
#prompt {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 10px;
  background: #030305;
  border-top: 1px solid #222;
}

#cmd {
  flex: 1;
  background: #000;
  color: #0f0;
  border: none;
  outline: none;
  padding: 8px 12px;
  border-radius: 999px;
}

/* Syntax colors */
.blue   { color: #4aa3ff; }
.green  { color: #6aff6a; }
.yellow { color: #ffd84a; }
.purple { color: #c084fc; }
</style>
</head>

<body>

<div id="app">

  <div id="editorWrap">
    <pre id="highlight"></pre>
    <textarea id="editor" spellcheck="false"
      placeholder="Write VSDTL here..."></textarea>
  </div>

  <div id="toolbar">
    <button id="runBtn" onclick="toggleRun()">▶ RUN</button>
  </div>

  <div id="output"></div>

  <div id="prompt">
    <button onclick="runCommand()">▶</button>
    <span>&gt;</span>
    <input id="cmd" placeholder='Insert(table) | Add(table,"x") | Display(#table)'>
  </div>

</div>

<script>
const editor = document.getElementById("editor");
const highlight = document.getElementById("highlight");
const output = document.getElementById("output");
const cmd = document.getElementById("cmd");
const runBtn = document.getElementById("runBtn");

let tables = {};
let running = false;

/* ---------- SYNTAX HIGHLIGHTING ---------- */

editor.addEventListener("input", updateHighlight);
editor.addEventListener("scroll", () => {
  highlight.scrollTop = editor.scrollTop;
});

function updateHighlight() {
  highlight.innerHTML = tokenize(editor.value);
}

function tokenize(src) {
  let out = "";
  let token = "";

  const flush = () => {
    out += colorToken(token);
    token = "";
  };

  for (const ch of src) {
    if (" \n=(),".includes(ch)) {
      flush();
      out += ch === "\n" ? "<br>" : ch;
    } else {
      token += ch;
    }
  }

  flush();
  return out;
}

function colorToken(tok) {
  if (!tok) return "";
  if (tok === "Display") return `<span class="yellow">${tok}</span>`;
  if (tok.startsWith("@")) return `<span class="blue">${tok}</span>`;
  if (tok.startsWith("#")) return `<span class="purple">${tok}</span>`;
  if (/^".*"$/.test(tok)) return `<span class="green">${tok}</span>`;
  return tok;
}

/* ---------- FILE RUNNER ---------- */

function toggleRun() {
  running ? stopRun() : runFile();
}

function runFile() {
  running = true;
  runBtn.textContent = "■ STOP";
  runBtn.style.background = "#e74c3c";

  output.textContent = "";
  tables = {};

  const start = performance.now();
  const lines = editor.value.split("\n");

  try {
    for (const line of lines) execLine(line.trim());
  } catch (e) {
    output.textContent += "Runtime error: " + e.message + "\n";
  }

  const ms = (performance.now() - start).toFixed(2);
  output.textContent += `\nExecuted in ${ms} ms\n`;

  stopRun();
}

function stopRun() {
  running = false;
  runBtn.textContent = "▶ RUN";
  runBtn.style.background = "#2ecc71";
}

function execLine(line) {
  if (!line) return;

  if (line.startsWith("@")) {
    const [n, v] = line.split("=");
    tables[n.slice(1).trim()] = JSON.parse(v);
  }
  else if (line.startsWith("Display")) {
    const t = line.match(/#(\w+)/)?.[1];
    output.textContent += (tables[t] || []).join(", ") + "\n";
  }
}

/* ---------- COMMAND PROMPT ---------- */

function runCommand() {
  const c = cmd.value.trim();
  if (!c) return;
  cmd.value = "";

  if (c.startsWith("Insert(")) {
    const n = c.slice(7, -1);
    tables[n] = [];
    editor.value += `\n@${n} = []`;
    updateHighlight();
  }

  else if (c.startsWith("Add(")) {
    const body = c.slice(4, -1);
    const name = body.split(",")[0].trim();
    const vals = body.match(/"[^"]+"/g)
      ?.map(v => v.replace(/"/g, "")) || [];

    if (!tables[name]) tables[name] = [];
    tables[name].push(...vals);

    const re = new RegExp(`@${name}\\s*=\\s*.*`);
    editor.value = editor.value.replace(
      re,
      `@${name} = ${JSON.stringify(tables[name])}`
    );
    updateHighlight();
  }

  else if (c.startsWith("Display")) {
    execLine(c);
  }
}
</script>

</body>
</html>